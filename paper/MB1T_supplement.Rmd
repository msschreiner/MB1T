---
title             : "Manybabies1 Test-Retest Supplementary Information"
shorttitle        : "MB1T supplementary"

figsintext        : yes
floatsintext      : no
figurelist        : no
tablelist         : no
footnotelist      : no
linenumbers       : yes
mask              : no
draft             : no

bibliography      : ["r-references.bib"]

documentclass     : "apa6"
classoption       : "man, donotrepeattitle"
output            : papaja::apa6_pdf
---

```{r setup, include = FALSE}
library(papaja)
library(dplyr)
library(tidyr)
library(readxl)
library(lme4)
library(readr)
library(langcog)
library(ggthemes)
library(tidyverse)
library(here)
library(knitr)
library(kableExtra)
library("langcog")
library(lmerTest)
library(ggplot2)
library(cowplot)

```

```{r analysis-preferences}
# Seed for random number generation
set.seed(42)
knitr::opts_chunk$set(cache.extra = knitr::rand_seed,echo = FALSE, warning = FALSE, message = FALSE)
```

## S1: Relationship between the number of trials infants contribute in each session

```{r}
# importing dataset (after excluding session and trial errors)
df_all <- read_csv(here("data","processed","df_all_after_exclusions.csv"))

lt_min <- 2                # minimum LT for inclusion
df_all <- df_all %>%
  filter(Condition != "training") %>%
  filter(LT >= lt_min) %>% 
  mutate(LT=ifelse(LT>18,18,LT)) # Truncating the looking times per trial at 18 seconds - consistent with decision from MB1

# calculate number of trials that each participant contributes per session
df_all_trials <- df_all %>%
  group_by(Subject_Unique,Session, Method) %>%
  summarise(N_trials = length(trial_num)) %>%
  mutate(
    N_trials = as.numeric(N_trials), #probably not needed, just to be safe
    Method = as.factor(Method)) %>%
  mutate(
    Session = case_when(
      Session==1 ~ "Test",
      Session==2 ~ "Retest"
    )
  )

df_all_trials <- df_all_trials %>% 
  pivot_wider(names_from = Session,values_from = N_trials)

#compute correlation
cor_trials <- cor.test(df_all_trials$Test,df_all_trials$Retest)
cor_trials_out <- apa_print(cor_trials)
```

```{r sfig1, fig.cap = "Correlation between the number of trials contributed in session 1 and session 2. Each data point represents one infant. Colored lines represent linear fits for each method."}
# jittering individual data points in order to make overlapping data points visible
trials <- ggplot(df_all_trials, aes(x=Test, y=Retest))+
  geom_jitter(width=0.5,height=0.5,aes(colour = Method),alpha=0.5)+
  geom_smooth(aes(colour = Method,group=Method),method=lm, se=FALSE,alpha=0.3)+
  geom_smooth(method=lm, colour= "black")+
  scale_x_continuous(seq(0,16,2),name="Number of Trials During Session 1")+
  scale_y_continuous(seq(0,16,2),name="Number of Trials During Session 2")+
  theme_cowplot()+
  theme(legend.position=c(0.02,0.8))
#plot
trials
```

Are there stable individual differences in how likely an infant is to contribute a high number of trials?
To answer this question, we conducted an exploratory analysis investigating whether there is a relationship between the number of trials an infant contributed in session 1 and session 2. 
Do infants who contribute a higher number of trials during their first testing session also tend to contribute more trials during their second testing session? 
A positive correlation between trial numbers during the first and second session would indicate that their is some stability in a given infants' likelihood of remaining attentive throughout the experiment.
On the other hand, the absence of a correlation would indicate that the number of trials a given infant contributes is not predictive of how many trials they might contribute during their next session.

We found a strong positive correlation between number of trials contributed during the first and the second session `r cor_trials_out$full_result` (see Figure 1). 
This result suggests that if infants contribute a higher number of trials in one session, compared to other infants, they are likely to contribute a higher number of trials in their next session.
This finding is consistent with the hypothesis that how attentive infants are throughout an experiment (and hence how many trials they contribute) is a stable individual difference, at least for some infant looking time tasks.
Researchers should therefore be mindful of the fact that decisions about including or excluding infants based on trials contributed may selectively sample a specific sub-set of the infant population they are studying [@debolt2020robust;@byers2021six].

## S2: Preference reversal
```{r,message=FALSE,warning=FALSE}

lt_min <- 2                # minumum LT for inclusion
min_trials_per_type <- 1  # min trials per type for inclusion

# cleaning data by using minimum LT for inclusion and minimum number of 1 trial per condition
# log-transformation of LT
data_clean <- df_all %>%
  filter(Condition != "training") %>%
  group_by(Subject, Subject_Unique,Session,Lab) %>%
  mutate(log_lt = log(LT))  %>% 
  mutate(
    N_below_threshold_lt = sum(LT < lt_min)
  ) %>%
  filter(LT >= lt_min) %>%
  mutate(N_IDS = sum(Condition == "IDS"),
         N_ADS = sum(Condition == "ADS"),
         total_trial_n = N_IDS + N_ADS) %>%
  filter(N_IDS >= min_trials_per_type & 
           N_ADS >= min_trials_per_type)

# aggregating log_lt for each Subject, Session and Condition
agg_subjects <- data_clean %>%
  group_by(Lab, Method, Subject, Subject_Unique,Language, Condition, Age,Session,total_trial_n) %>%
  summarise(MeanLogLT = mean(log_lt),
            mean_lt = mean(LT)) %>%
  mutate(ConditionC = ifelse(Condition == "IDS", .5, -.5)) %>%
  mutate(language_recoded = case_when(
    Lab %in% c("InfantCog-UBC","infantll-madison") & Language == "English" ~ "American English",
    TRUE ~ Language
  )) %>%
  mutate(Native = ifelse(language_recoded == "American English", TRUE, FALSE))

# creating a wide format of the dataset and calculating difference in log_lt for IDS and ADS and the proportion of IDS looking
all_agg_subjects_paired <- agg_subjects %>%
  select(-ConditionC) %>% 
  #pivot_wider(names_from = Condition, values_from = MeanLogLT) %>%
  select(-MeanLogLT) %>%
  pivot_wider(names_from = Condition, values_from = mean_lt) %>%
  mutate(Diff = IDS - ADS, 
         Prop = IDS / (IDS + ADS),
         binary_pref = case_when(
           is.na(Diff) ~ NA_character_,
           Diff > 0 ~ "IDS_preference",
           Diff < 0 ~ "ADS_preference",
           Diff == 0 ~ "no_preference"
         ))

reversal <- all_agg_subjects_paired %>%
  select(Subject_Unique, Session, binary_pref)

reversal <- reversal[,c(2, 6:8)]

reversal <- reversal %>%
  group_by(Subject_Unique) %>%
  pivot_wider(names_from = Session, values_from = binary_pref)

names(reversal) <- c("Method", "Subject_Unique","Pref_Test" , "Pref_Retest")
  
reversal <- reversal %>%
  group_by(Subject_Unique) %>%
  mutate(reversal = case_when((Pref_Test == "IDS_preference" & Pref_Retest == "IDS_preference")  ~ 0,
                              (Pref_Test == "ADS_preference" & Pref_Retest == "ADS_preference")  ~ 0,
                              (Pref_Test == "IDS_preference" & Pref_Retest == "ADS_preference")  ~ 1,
                              (Pref_Test == "ADS_preference" & Pref_Retest == "IDS_preference")  ~ 1))

n_reversal <- length(reversal$reversal[reversal$reversal==1])
n_total <- length(reversal$reversal)

perc_reversal <- n_reversal/n_total*100
```

`r perc_reversal` percent of the infants had a preference reversal from test to retest session.

## S3: Deviations from the preregistration

Below, we document all deviations from the preregistered methods and analyses [https://osf.io/v5f8t](https://osf.io/v5f8t).

- All infants with usable data for both test and retest session were included in the analyses, regardless of the number of total of infants a lab was able to contribute after exclusion. This decision is consistent with past decisions in ManyBabies projects to be as inclusive about data inclusion as possible [@manybabies2020quantifying].
- A small number of infants with a time between sessions above 31 days were also included in the analyses (n=2).
- Consistent with analytic decisions in ManyBabies 1 [@manybabies2020quantifying], total looking times were truncated at 18 seconds (the maximum trial time) in the small number of cases where recorded looking times were slightly greater than 18s (presumably due to small measurement error in recording infant looking times).


\newpage

# References
```{r create_r-references}
r_refs(file = "r-references.bib")
```

\begingroup
\setlength{\parindent}{-0.5in}
\setlength{\leftskip}{0.5in}

<div id = "refs"></div>
\endgroup
